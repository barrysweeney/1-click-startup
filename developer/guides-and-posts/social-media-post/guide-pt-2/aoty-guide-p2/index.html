<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>PySelenium Album Searcher</title>
    <link
            rel="stylesheet"
            href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
            integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk"
            crossorigin="anonymous"
    />
    <link href="themes/prism.css" rel="stylesheet"/>
    <link rel="shortcut icon" type="image/png" href="images/bs-logo.png"/>

    <link rel="stylesheet" href="style.css"/>
</head>
<body>
<div class="container">
    <h1>Searching Album of The Year using Flask, Selenium, Docker, and React - Part 2</h1>
    <a href="https://github.com/barrysweeney/1-click-startup/tree/master/guides-and-posts/album-of-the-day">Click here
        for post's source code</a>
    <div class="embed-responsive embed-responsive-16by9">
        <iframe class="embed-responsive-item" src="https://www.youtube.com/embed/S6gee91Q5gc" frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen></iframe>
    </div>
    <p>In this tutorial we'll design an app to find out which albums were released on a specific day. But you'll learn
        so
        much more along the way...</p>
    <img src="images/company-logos.png" alt="logos for Album Of The Year, Python, Selenium, and Docker"/>
    <p>In <a href="#">part 1</a> we answered the question</p>
    <blockquote><em>"Can I find out which albums were released on my birthday?"</em></blockquote>
    <p>You sure can, <strong>just read on to find out how.</strong></p>
    <p>In <a href="#">part 1 of this guide</a> we brought up that if you can relate to any of these then you're <em>definitely</em>
        in the right place.</p>
    <ul>
        <li>If you want to learn some Docker and Selenium basics in a fun project before moving on to more complex
            Docker
            Compose and automated testing applications.
        </li>
        <li>If you're a new developer stuck in <a href="https://www.freecodecamp.org/news/escape-tutorial-purgatory/">tutorial
            purgatory</a> who wants to wrap their head around more challenging concepts then you can go deeper down the
            rabbit
            hole by following the links throughout the guide.
        </li>
        <li>If you're a student or are learning to code and searching for a project to talk about in interviews to help
            get
            your foot through the door.
        </li>
    </ul>
    <p>In this guide, the same applies, <i>and</i> in addition, this guide is <em>absolutely</em> for you if you're
        interested in
        any of these.</p>
    <ul>
        <li>Crating a custom frontend with the frontend JavaScript framework React.</li>
        <li>Adapting a Python console app into a Flask webserver.</li>
    </ul>
    <p>From <a href="https://reactjs.org/">ReactJS</a>:</p>
    <blockquote>
        A JavaScript library for building user interfaces
    </blockquote>
    <p>From <a href="https://pythonbasics.org/what-is-flask-python/">Python Basic - What is Flask Python?</a>:</p>
    <blockquote>"Flask is a web application framework written in Python.

        A Web Application Framework or simply a
        Web Framework represents a collection of libraries and
        modules that enable web application developers to write applications without worrying about low-level
        details"
    </blockquote>
    <p>Looking for source code? <br> <a
            href="https://github.com/barrysweeney/1-click-startup/tree/master/guides-and-posts/album-of-the-day">Jump to
        the Github Repo <i class="fab fa-github"></i></a></p>
    <h1>Searching Album of The Year using Flask, Selenium, Docker, and React</h1>
    <p>Firstly we'll use create-react-app to generate the template for our frontend</p>
    <p>Next we'll customize our frontend interface and set up the functions that send requests to our Flask
        webserver.</p>
    <p>Then we'll adapt our Python console app into a Flask webserver.</a>.</p>
    <p>We'll wrap up with a discussion of our results and how we could take this further..</p>
    <ul>
        <li><a href="#dev-env">Configuring your development environment</a></li>
        <li><a href="#coding">React Frontend</a></li>
        <li><a href="#results">Flask Webserver Backend</a></li>
        <li><a href="#results">Results</a></li>
        <li><a href="#whats-next">What's Next?</a></li>
        <li><a href="#troubleshooting">Troubleshooting</a></li>
    </ul>
    <h2 id="dev-env">Configuring your development environment</h2>
    <p>If you want to follow along to the tutorial you can take some time to setup your environment by installing Docker
        using either of these guides</p>
    <ul>
        <li><a href="https://docs.docker.com/engine/install/">Install Docker Engine on Linux</a></li>
        <li><a href="https://docs.docker.com/docker-for-mac/install/">Install Docker Desktop on Mac</a></li>
        <li><a href="https://docs.docker.com/docker-for-windows/install/">Install Docker Desktop on Windows</a></li>
    </ul>
    <p>Either will help you setup the required software for this tutorial.</p>
    <p>In addition to Docker, you'll also need <a href="https://nodejs.org/en/">NodeJs</a> which you can install with
        either of these guides</p>
    <ul>
        <li><a href="https://www.digitalocean.com/community/tutorials/how-to-install-node-js-on-ubuntu-18-04">Install
            NodeJS on Ubuntu</a></li>
        <li><a href="https://www.fosstechnix.com/install-node-js-on-mac/">Install NodeJS on Mac</a></li>
        <li><a href="https://www.fosstechnix.com/how-to-install-node-js-on-windows/">Install NodeJS on Windows</a></li>
    </ul>
    <p>You can now move on to creating our React app.</p>
    <h2 id="coding">React Frontend</h2>
    <p>First we can start with a generated <a href="https://reactjs.org/docs/glossary.html#single-page-application">single-page
        application</a> with the help of <code>create-react-app</code></p>
    <pre><code class="language-bash">npx create-react-app aoty-frontend
cd aoty-frontend
npm start</code></pre>
    <p><code>npx is the package runner tool that comes with npm which is the node package manager installed along with
        NodeJS.</code></p>
    <p>The generated app will now be in the folder <code>aoty-frontend</code> which I would now recommend opening with
        your IDE/text editor of choice.</p>
    <p>We'll start be rewriting <code>src/App.js</code>. We can change the <code>App()</code> function to</p>
    <pre><code class="language-jsx">function App() {
  return (
    &lt;div&gt;&lt;/div&gt;
  );
}</code></pre>
    <p>Now we can add a heading and the basic html for the form</p>
    <pre><code class="language-jsx">&lt;div&gt;
    &lt;h1&gt;Album of the Year Searcher&lt;/h1&gt;
    &lt;form action="#"&gt;
     &lt;label&gt;
       Date
       &lt;input type="date" name="date" id="date"/&gt;
     &lt;/label&gt;
     &lt;button type="submit" id="submit-date"&gt;Search&lt;/button&gt;
    &lt;/form&gt;
&lt;/div&gt;</code></pre>
    <p>Now, under the form we want to add a loading spinner if the app is in the state of searching for albums.</p>
    <pre><code class="language-jsx">{this.state.searching ?
        &lt;div className="text-center"&gt;
          &lt;div className="spinner-border" role="status"&gt;
            &lt;span className="sr-only"&gt;Loading...&lt;/span&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        : null}</code></pre>
    <p>The class names are actually Bootstrap specific which is a CSS framework for developing responsive sites.</p>
    <p>We'll return to Bootstrap later, but for now, we'll want a way to display the that albums our search found. Just
        under the previous code we can map over the results returned from our search to list items elements.</p>
    <pre><code class="language-jsx">{this.state.results.length !== 0 ? (
        &lt;ul&gt;{
              this.state.results.map((result, i) =&gt;
                &lt;li key={i}&gt;{result}&lt;/li&gt;
              )
            }&lt;/ul&gt;
    ) : null}</code></pre>
    <p>We'll want to take the form submission into our own hands next and add a little styling</p>
    <pre><code class="language-jsx">&lt;form onSubmit={this.submitHandler.bind(this)} action="#" style={{display: `grid`, gap: `10px`}}&gt;</code></pre>
    <p>We'll change the <code>App</code> function to a class now, here's where we're at now, also note the new import
    </p>
    <pre><code class="language-jsx">import React, {Component} from "react"

class App extends Component {
    constructor(props) {
        super(props);
        this.state = {
            results: [],
            searching: false,
        };
    }

    render() {
        return (
                &lt;div&gt;
                    ...
                &lt;/div&gt;
        )
    }
}</code></pre>
    <p>Now we can add the <code>submitHandler</code> function that is called on form submission</p>
    <pre><code class="language-jsx">    async submitHandler(e) {
        // Prevent browser's default form submission behaviour
        e.preventDefault()
        // Extract date from form and split into array
        const date = e.target.date.value.split("-")
        // Store year, month code, and formatted day from date array
        const year = date[0]
        const monthCode = date[1]
        const day = parseInt(date[2], 10) // 01 becomes 1, etc.

        // Create request body
        const body = {}
        body.day = day
        body.month_code = monthCode
        body.year = year

        // Set searching to true to display loading spinner
        this.setState({
            searching: true,
        })

        // Send POST request to backend and await a response
        const response = await fetch(`http://localhost:5000/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(body)
        })
        // If the response is OK then set state to display albums
        if (response.status === 200) {
            const data = await response.json();
            this.setState({
                results: data.results,
                searching: false,
            })
        }
    }</code></pre>
    <!--    ************************************************************    -->
    <p>As we mentioned earlier... From <a href="">w3schools - What is Bootstrap?</a>:</p>
    <blockquote>"Bootstrap is the most popular CSS Framework for developing responsive and mobile-first websites."
    </blockquote>


    <pre><code class="language-jsx">import logo from './logo.svg';
import Container from 'react-bootstrap/Container'
import './App.css';
import React, {Component} from "react"

class App extends Component {
    constructor(props) {
        super(props);
        this.state = {
            results: [],
            year: 2000,
            day: 1,
            searching: false,
        };
    }

    async yearHandler(e) {
        this.setState({
            year: e.target.value
        })
    }

    async dayHandler(e) {
        this.setState({
            day: e.target.value
        })
    }

    async submitHandler(e) {
        e.preventDefault()
        const date = e.target.date.value.split("-")
        const year = date[0]
        const monthCode = date[1]
        const day = parseInt(date[2], 10)

        const body = {}
        body.day = day
        body.month_code = monthCode
        body.year = year

        this.setState({
            searching: true,
        })

        const response = await fetch(`http://localhost:5000/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(body)
        })
        if (response.status === 200) {
            const data = await response.json();
            this.setState({
                results: data.results,
                searching: false,
            })
        }

    }

    render() {
        return (
            &lt;Container&gt;
                &lt;div style={{display: `grid`, gap: `20px`}}&gt;
                    &lt;h1&gt;Album of the Year Searcher&lt;/h1&gt;
                    &lt;form onSubmit={this.submitHandler.bind(this)} action="#" style={{display: `grid`, gap: `10px`}}&gt;
                        &lt;label style={{display: `grid`, gap: `10px`}}&gt;
                            Date
                            &lt;input type="date" name="date" id="date" min="1950-01-01"/&gt;
                        &lt;/label&gt;
                        &lt;button type="submit" id="submit-date"&gt;Search&lt;/button&gt;
                    &lt;/form&gt;
                    &lt;div&gt;
                        {this.state.searching ? &lt;div className="text-center"&gt;
                            &lt;div className="spinner-border" role="status"&gt;
                                &lt;span className="sr-only"&gt;Loading...&lt;/span&gt;
                            &lt;/div&gt;
                        &lt;/div&gt; : null}
                        {this.state.results.length !== 0 ? (
                            &lt;ul&gt;{
                                this.state.results.map((result, i) =&gt;
                                    &lt;li key={i}&gt;{result}&lt;/li&gt;
                                )
                            }&lt;/ul&gt;
                        ) : null}
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/Container&gt;
        )
    }
}

export default App;
</code></pre>
    <p>We can now move on to programming our Flask backend.</p>
    <h2 id="flask">Flask webserver backend</h2>
    <p>Continuing from <a href="#">part 1</a> of the guide, we'll rewrite <code>app.py</code> to be the following:</p>
    <pre><code class="language-python">from flask import Flask, request
from selenium import webdriver
from selenium.common.exceptions import NoSuchElementException, \
    StaleElementReferenceException
import time
import os
import requests
import json
from flask_cors import CORS, cross_origin

app = Flask(__name__)
# Enable CORS to permit requests from the frontend to the backend (a different origin)
CORS(app)  # Enables CORS for all routes
# Allow Content-Type header
app.config['CORS_HEADERS'] = 'Content-Type'

# Start Selenium webdriver container
os.system(
    'sudo docker run --name my-selenium-container -d -p 4444:4444  -v /dev/shm:/dev/shm selenium/standalone-firefox:4.0.0-beta-1-prerelease-20210210')

# Wait for Selenium webdriver container to be ready
ready = False
time.sleep(5)
while not ready:
    try:
        r = requests.get('http://localhost:4444/wd/hub/status', timeout=1)
        status = r.status_code
        if status == 200:
            ready = True
    except ConnectionResetError or ConnectionError:
        continue


@app.route('/', methods=['POST'])
@cross_origin()
def hello_world():
    data = request.json
    day = data['day']
    month_code = data['month_code']
    year = data['year']
    month = ''
    month_name_short = ''

    print(month_code)

    if month_code == '01':
        month = 'january'
        month_name_short = 'Jan'
    elif month_code == '02':
        month = 'february'
        month_name_short = 'Feb'
    elif month_code == '03':
        month = 'march'
        month_name_short = 'Mar'
    elif month_code == '04':
        month = 'april'
        month_name_short = 'Apr'
    elif month_code == '05':
        month = 'may'
        month_name_short = 'May'
    elif month_code == '06':
        month = 'june'
        month_name_short = 'Jun'
    elif month_code == '07':
        month = 'july'
        month_name_short = 'Jul'
    elif month_code == '08':
        month = 'october'
        month_name_short = 'Aug'
    elif month_code == '09':
        month = 'september'
        month_name_short = 'Sep'
    elif month_code == '10':
        month = 'october'
        month_name_short = 'Oct'
    elif month_code == '11':
        month = 'november'
        month_name_short = 'Nov'
    elif month_code == '12':
        month = 'december'
        month_name_short = 'Dec'

    release_date_to_search = '%s %s' % (month_name_short, day)
    driver = webdriver.Remote(desired_capabilities=webdriver.DesiredCapabilities.FIREFOX,
                              command_executor="http://localhost:4444/wd/hub")
    driver.get(
        "https://www.albumoftheyear.org/%s/releases/%s-%s.php?s=release&genre=all" % (year, month, month_code))

    all_albums_loaded = False

    while not all_albums_loaded:
        try:
            show_more_button_container = driver.find_element_by_class_name('showMore')
            time.sleep(3)
            driver.execute_script("arguments[0].click();",
                                  show_more_button_container.find_element_by_class_name('largeButton'))
            time.sleep(1)
        except StaleElementReferenceException:
            continue
        except NoSuchElementException:
            all_albums_loaded = True

    albums = driver.find_elements_by_class_name('albumBlock')

    response = []
    for album in albums:
        album_release_date = album.find_element_by_class_name('date').text
        if album_release_date == release_date_to_search:
            album_title = album.find_element_by_class_name('albumTitle').text
            artist_title = album.find_element_by_class_name(
                'artistTitle').text
            response.append('%s - %s' % (album_title, artist_title))

    if len(response) == 0:
        response.append('No albums found')

    driver.close()
    #
    # # remove Selenium container
    # os.system(
    #     'sudo docker rm -f my-selenium-container')

    return json.dumps({'results': response}), 200, {'ContentType': 'application/json'}


if __name__ == '__main__':
    app.run()
</code>
    </pre>
    <p>I like to start by creating a new Python project with a Virtual Environment in PyCharm but you can use any IDE or
        text editor you prefer. You can set up your own environment if your editor doesn't automatically configure it
        for you by executing the command <code>venv</code>:</p>
    <pre>
        <code>
            python3 -m venv /path/to/new/virtual/environment
        </code>
    </pre>
    <p>For more info you can check out the <a href="https://docs.python.org/3/library/venv.html">official Python
        documentation on venv </a></p>
    <p>Note that you may need to change <code>python3</code> to <code>python</code> depending on which version you have
        installed.</p>
    <p>We'll start by installing the necessary packages/p>
    <pre><code>pip3 install selenium
pip3 install requests
pip3 install flask_cors</code>
    </pre>
    <p>Note that you may need to change <code>pip3</code> to <code>pip</code> depending on which version you have
        installed.</p>
    <p>Congrats! Now let's see the results of our hard work in the next section.</p>
    <h2 id="results">Results</h2>
    <p>Let's try searching for the albums released on a certain date to see our results.</p>
    <p>Inside the virtual environment, we can run</p>
    <pre><code>python3 app.py</code></pre>
    <p>to start our webserver</p>
    <p>If you've followed along and used <code>sudo</code> in the docker run command you'll be prompted for your
        password and then we can move to our frontend application at <a href="http://localhost:3000">http://localhost:3000</a>
    </p>
    <
    <h2 id="whats-next">What's Next?</h2>
    <p>Remember you can <a
            href="https://github.com/barrysweeney/1-click-startup/tree/master/guides-and-posts/album-of-the-day">grab
        the source code</a> so you can take this and run with it adapting it however you like, read on to find out what
        my plans are for this project and ideas about where this could go next.</p>
    <p>I was motivated to create this project because I couldn't find a site that could be used to search for albums by
        a specific release date. I'll be designing the frontend for this program in an upcoming post and showing how you
        can deploy it so you can
        use and share it with others.</p>
    <p>We can improve our frontend by designing with our users in mind with an interface integrating the album covers
        and we could even add filtering by genre.</p>
    <p>Stay tuned to <a href="https://www.barrysweeney.com/blog/">my blog</a>, you don't want to miss out!</p>
    <h2 id="troubleshooting">Bonus: Troubleshooting</h2>
    <p>Here's some resources for resolving common errors you might run into along the way in this guide or in your own
        explorations.</p>
    <ul>
        <li><code class="language-python">requests.exceptions.ConnectionError: ('Connection aborted.',
            ConnectionResetError(104, 'Connection reset
            by peer'))</code> - this is a common error coined <a
                href="http://www.itmaybeahack.com/homepage/iblog/architecture/C551260341/E20081031204203/index.html">The
            Python "Connection Rest By Peer" Problem</a>. You can
            read more about it in <a href="https://stackoverflow.com/a/383816/9472445">this StackOverflow post by user
                S.Lott</a>. In our case it will likely arise from trying to access the status endpoint of the Selenium
            container before the container is ready. You can use <code class="language-python">time.sleep(1)</code>
            before making a request to <code>http://localhost:4444/wd/hub/status</code> and adjusting the time to fit
            your needs.
        </li>
        <li><code class="language-shell">pip: command not found</code> - this is likely a problem relating to your
            environment as described (along with solutions) in <a
                    href="https://careerkarma.com/blog/python-pip-command-not-found/">this post by James Gallagher on
                Career Karma</a>. It may be as simple as changing <code>pip</code> to <code>pip3</code> or you may need
            to actually install pip3, for example with apt-get <code>sudo apt-get -y install python3-pip</code>
        </li>
        <li><code class="language-python">StaleElementReferenceException</code> - our WebElement can be destroyed and
            re-rendered in
            the DOM so we'll need to retry by using <code>continue</code> if our reference becomes stale. <a
                    href="https://stackoverflow.com/a/16244739/9472445">This StackOverflow answer by user Ardesco</a>
            describes the situation more clearly. We can catch this exception in an <code
                    class="language-python">except</code> block and tell our code to retry a certain operation until the
            exception doesn't occur. You can see <a href="#stale-element">the example we've used in this guide</a> where
            our solution was to use the
            <code class="language-python">continue</code> keyword inside a <code class="language-python">while</code>
            loop.
        </li>
        <li><code class="language-shell">Element is not clickable at point (x,y) because another element obscures
            it</code> - You can see <a href="https://stackoverflow.com/a/37880313/9472445">this StackOverflow answer by
            user RemcoW</a> for more details and an explanation of our solution in this guide which was to use <code
                class="language-python">driver.execute_script("arguments[0].click();", element)</code> as opposed to the
            <code class="language-python">click()</code> method of the <code>WebElement</code>
            object returned by <code class="language-python">find_element_by_id</code></li>
        <li><code class="language-shell">Failed to connect to localhost port 4444: Connection refused</code> - If you're
            planning
            to access the Selenium webdriver endpoint from within a different Docker container you can change
            <code>http://localhost:4444/wd/hub</code> to <code>http://172.17.0.1:4444/wd/hub</code> or
            <code>http://host.docker.internal:4444/wd/hub</code>. The
            rationale behind this is provided in <a href="https://stackoverflow.com/a/48547074/9472445">this
                StackOverflow answer by user devnev</a>.
        </li>
    </ul>

</div>

</div>
<script src="https://kit.fontawesome.com/726e49cea0.js" crossorigin="anonymous"></script>
<script src="prism.js"></script>
</body>
</html>
